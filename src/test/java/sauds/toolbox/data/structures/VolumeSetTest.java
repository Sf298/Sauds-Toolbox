package sauds.toolbox.data.structures;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.tools4j.spockito.jupiter.TableSource;

import java.math.BigInteger;

import static java.lang.Integer.parseInt;
import static org.assertj.core.api.Assertions.assertThat;

public class VolumeSetTest {

    private static final Cuboid initialCuboid = new Cuboid(new Coordinate(1,2), new Coordinate(4,5));

    @TableSource({
            "| x1 | x2 | y1 | y2 | area | name                                           |",
            "|----|----|----|----|------|------------------------------------------------|",
            "|  1 |  4 |  2 |  5 |   16 | identical                                      |",
            "|  0 |  5 |  1 |  6 |   36 | this contains initialCuboid                    |",
            "|  2 |  3 |  3 |  4 |   16 | initialCuboid contains this                    |",

            "|  1 |  4 |  3 |  6 |   20 | equal x, shifted overlapping +y                |",
            "|  1 |  4 |  1 |  4 |   20 | equal x, shifted overlapping -y                |",
            "|  2 |  5 |  2 |  5 |   20 | shifted overlapping +x, equal y                |",
            "|  0 |  3 |  2 |  5 |   20 | shifted overlapping -x, equal y                |",

            "|  2 |  3 |  3 |  6 |   18 | inner x, shifted overlapping +y                |",
            "|  2 |  3 |  1 |  4 |   18 | inner x, shifted overlapping -y                |",
            "|  2 |  5 |  3 |  4 |   18 | shifted overlapping +x, inner y                |",
            "|  0 |  3 |  3 |  4 |   18 | shifted overlapping -x, inner y                |",

            "|  0 |  5 |  3 |  6 |   28 | outer x, shifted overlapping +y                |",
            "|  0 |  5 |  1 |  4 |   28 | outer x, shifted overlapping -y                |",
            "|  2 |  5 |  1 |  6 |   28 | shifted overlapping +x, outer y                |",
            "|  0 |  3 |  1 |  6 |   28 | shifted overlapping -x, outer y                |",

            "|  1 |  4 |  6 |  9 |   32 | equal x, shifted adjacent +y                   |",
            "|  1 |  4 |  0 |  1 |   24 | equal x, shifted adjacent -y                   |",
            "|  5 |  8 |  2 |  5 |   32 | shifted adjacent +x, equal y                   |",
            "| -3 |  0 |  2 |  5 |   32 | shifted adjacent -x, equal y                   |",

            "|  1 |  4 |  7 |  9 |   28 | equal x, shifted unconnected +y                |",
            "|  1 |  4 | -1 |  0 |   24 | equal x, shifted unconnected -y                |",
            "|  6 |  8 |  2 |  5 |   28 | shifted unconnected +x, equal y                |",
            "| -3 | -1 |  2 |  5 |   28 | shifted unconnected -x, equal y                |",

            "|  2 |  5 |  3 |  6 |   23 | shifted overlapping +x, shifted overlapping +y |",
            "|  2 |  5 |  1 |  4 |   23 | shifted overlapping +x, shifted overlapping -y |",
            "|  0 |  3 |  3 |  6 |   23 | shifted overlapping -x, shifted overlapping +y |",
            "|  0 |  3 |  1 |  4 |   23 | shifted overlapping -x, shifted overlapping -y |",

            "|  2 |  3 |  1 |  6 |   20 | centers overlapping (plus shape)               |"
    })
    @ParameterizedTest(name = "{5}")
    public void testAdd(int x1, int x2, int y1, int y2, int expectedArea, String name) {
        VolumeSet underTest = new VolumeSet();
        underTest.add(initialCuboid);

        Cuboid testCuboid = new Cuboid(new Coordinate(x1,y1), new Coordinate(x2,y2));
        underTest.add(testCuboid);

        assertThat(countLayeredPoints(underTest)).isLessThanOrEqualTo(1);

        BigInteger actualArea = underTest.area();
        assertThat(actualArea).isEqualTo(BigInteger.valueOf(expectedArea));
    }

    @TableSource({
            "| x1 | x2 | y1 | y2 | area | name                                           |",
            "|----|----|----|----|------|------------------------------------------------|",
            "|  1 |  4 |  2 |  5 |    0 | identical                                      |",
            "|  0 |  5 |  1 |  6 |    0 | this contains initialCuboid                    |",
            "|  2 |  3 |  3 |  4 |   12 | initialCuboid contains this                    |",

            "|  1 |  4 |  3 |  6 |    4 | equal x, shifted overlapping +y                |",
            "|  1 |  4 |  1 |  4 |    4 | equal x, shifted overlapping -y                |",
            "|  2 |  5 |  2 |  5 |    4 | shifted overlapping +x, equal y                |",
            "|  0 |  3 |  2 |  5 |    4 | shifted overlapping -x, equal y                |",

            "|  2 |  3 |  3 |  6 |   10 | inner x, shifted overlapping +y                |",
            "|  2 |  3 |  1 |  4 |   10 | inner x, shifted overlapping -y                |",
            "|  2 |  5 |  3 |  4 |   10 | shifted overlapping +x, inner y                |",
            "|  0 |  3 |  3 |  4 |   10 | shifted overlapping -x, inner y                |",

            "|  0 |  5 |  3 |  6 |    4 | outer x, shifted overlapping +y                |",
            "|  0 |  5 |  1 |  4 |    4 | outer x, shifted overlapping -y                |",
            "|  2 |  5 |  1 |  6 |    4 | shifted overlapping +x, outer y                |",
            "|  0 |  3 |  1 |  6 |    4 | shifted overlapping -x, outer y                |",

            "|  1 |  4 |  6 |  9 |   16 | equal x, shifted adjacent +y                   |",
            "|  1 |  4 |  0 |  1 |   16 | equal x, shifted adjacent -y                   |",
            "|  5 |  8 |  2 |  5 |   16 | shifted adjacent +x, equal y                   |",
            "| -3 |  0 |  2 |  5 |   16 | shifted adjacent -x, equal y                   |",

            "|  1 |  4 |  7 |  9 |   16 | equal x, shifted unconnected +y                |",
            "|  1 |  4 | -1 |  0 |   16 | equal x, shifted unconnected -y                |",
            "|  6 |  8 |  2 |  5 |   16 | shifted unconnected +x, equal y                |",
            "| -3 | -1 |  2 |  5 |   16 | shifted unconnected -x, equal y                |",

            "|  2 |  5 |  3 |  6 |    7 | shifted overlapping +x, shifted overlapping +y |",
            "|  2 |  5 |  1 |  4 |    7 | shifted overlapping +x, shifted overlapping -y |",
            "|  0 |  3 |  3 |  6 |    7 | shifted overlapping -x, shifted overlapping +y |",
            "|  0 |  3 |  1 |  4 |    7 | shifted overlapping -x, shifted overlapping -y |",

            "|  2 |  3 |  1 |  6 |    8 | centers overlapping (plus shape)               |"
    })
    @ParameterizedTest(name = "{5}")
    public void testSubtract(int x1, int x2, int y1, int y2, int expectedArea, String name) {
        VolumeSet underTest = new VolumeSet();
        underTest.add(initialCuboid);

        Cuboid testCuboid = new Cuboid(new Coordinate(x1,y1), new Coordinate(x2,y2));
        underTest.subtract(testCuboid);

        assertThat(countLayeredPoints(underTest)).isLessThanOrEqualTo(1);

        BigInteger actualArea = underTest.area();
        assertThat(actualArea).isEqualTo(BigInteger.valueOf(expectedArea));
    }

    @TableSource({
            "| x1 | x2 | y1 | y2 | area | name                                           |",
            "|----|----|----|----|------|------------------------------------------------|",
            "|  1 |  4 |  2 |  5 |   16 | identical                                      |",
            "|  0 |  5 |  1 |  6 |   16 | this contains initialCuboid                    |",
            "|  2 |  3 |  3 |  4 |    4 | initialCuboid contains this                    |",

            "|  1 |  4 |  3 |  6 |   12 | equal x, shifted overlapping +y                |",
            "|  1 |  4 |  1 |  4 |   12 | equal x, shifted overlapping -y                |",
            "|  2 |  5 |  2 |  5 |   12 | shifted overlapping +x, equal y                |",
            "|  0 |  3 |  2 |  5 |   12 | shifted overlapping -x, equal y                |",

            "|  2 |  3 |  3 |  6 |    6 | inner x, shifted overlapping +y                |",
            "|  2 |  3 |  1 |  4 |    6 | inner x, shifted overlapping -y                |",
            "|  2 |  5 |  3 |  4 |    6 | shifted overlapping +x, inner y                |",
            "|  0 |  3 |  3 |  4 |    6 | shifted overlapping -x, inner y                |",

            "|  0 |  5 |  3 |  6 |   12 | outer x, shifted overlapping +y                |",
            "|  0 |  5 |  1 |  4 |   12 | outer x, shifted overlapping -y                |",
            "|  2 |  5 |  1 |  6 |   12 | shifted overlapping +x, outer y                |",
            "|  0 |  3 |  1 |  6 |   12 | shifted overlapping -x, outer y                |",

            "|  1 |  4 |  6 |  9 |    0 | equal x, shifted adjacent +y                   |",
            "|  1 |  4 |  0 |  1 |    0 | equal x, shifted adjacent -y                   |",
            "|  5 |  8 |  2 |  5 |    0 | shifted adjacent +x, equal y                   |",
            "| -3 |  0 |  2 |  5 |    0 | shifted adjacent -x, equal y                   |",

            "|  1 |  4 |  7 |  9 |    0 | equal x, shifted unconnected +y                |",
            "|  1 |  4 | -1 |  0 |    0 | equal x, shifted unconnected -y                |",
            "|  6 |  8 |  2 |  5 |    0 | shifted unconnected +x, equal y                |",
            "| -3 | -1 |  2 |  5 |    0 | shifted unconnected -x, equal y                |",

            "|  2 |  5 |  3 |  6 |    9 | shifted overlapping +x, shifted overlapping +y |",
            "|  2 |  5 |  1 |  4 |    9 | shifted overlapping +x, shifted overlapping -y |",
            "|  0 |  3 |  3 |  6 |    9 | shifted overlapping -x, shifted overlapping +y |",
            "|  0 |  3 |  1 |  4 |    9 | shifted overlapping -x, shifted overlapping -y |",

            "|  2 |  3 |  1 |  6 |    8 | centers overlapping (plus shape)               |"
    })
    @ParameterizedTest(name = "{5}")
    public void testRetain(int x1, int x2, int y1, int y2, int expectedArea, String name) {
        VolumeSet underTest = new VolumeSet();
        underTest.add(initialCuboid);

        Cuboid testCuboid = new Cuboid(new Coordinate(x1,y1), new Coordinate(x2,y2));
        underTest.retain(testCuboid);

        Cuboid.printByIndex(initialCuboid, testCuboid);
        Cuboid.print2DLayers(initialCuboid, testCuboid);

        assertThat(countLayeredPoints(underTest)).isLessThanOrEqualTo(1);

        BigInteger actualArea = underTest.area();
        assertThat(actualArea).isEqualTo(BigInteger.valueOf(expectedArea));
    }

    @Test
    public void testPerformance() {
        //<editor-fold desc="input instructions">
        String[][] instructions = {
                {"on", "-9:45,-15:37,-2:46"},
                {"on", "-48:2,-11:37,3:48"},
                {"on", "-47:4,-47:-3,-12:34"},
                {"on", "-24:29,-12:40,-20:29"},
                {"on", "-48:3,-38:16,-22:31"},
                {"on", "-35:13,-10:43,-11:42"},
                {"on", "-4:47,1:47,-26:18"},
                {"on", "-49:1,-29:22,-44:2"},
                {"on", "-12:33,-14:38,-9:35"},
                {"on", "-44:8,0:46,-28:20"},
                {"off", "-44:-31,-37:-21,35:49"},
                {"on", "-2:42,-49:-4,-10:39"},
                {"off", "-26:-17,-38:-29,-32:-18"},
                {"on", "-41:10,-1:49,-22:24"},
                {"off", "-49:-35,-26:-15,11:24"},
                {"on", "-5:47,-34:10,-3:42"},
                {"off", "-16:-7,-9:0,-4:12"},
                {"on", "-45:1,-25:22,-2:49"},
                {"off", "21:40,30:44,-16:1"},
                {"on", "-11:37,-44:1,-20:25"},
                {"on", "7379:15679,62885:66145,40785:66699"},
                {"on", "55922:93809,1651:21593,-29830:-6845"},
                {"on", "-31566:-20771,49570:87512,-38744:-20396"},
                {"on", "4993:41166,-27079:-6497,-88189:-66473"},
                {"on", "60741:69319,-13925:8370,-62720:-33863"},
                {"on", "34284:42689,-71439:-58324,22610:47957"},
                {"on", "8592:42171,-65708:-43885,-61206:-46568"},
                {"on", "64371:79931,28477:37185,13392:20753"},
                {"on", "-59117:-37612,-64167:-37759,35921:54572"},
                {"on", "-14064:20202,-90417:-70077,25371:40391"},
                {"on", "-67395:-41025,17787:31773,-57128:-48199"},
                {"on", "-70962:-46942,19586:45376,-54426:-31169"},
                {"on", "31777:46666,-28152:-20207,-66876:-55373"},
                {"on", "13530:27088,-90327:-70591,-1912:25782"},
                {"on", "40408:67678,38887:66828,-30776:-13301"},
                {"on", "-29414:-16610,56466:86239,20871:32428"},
                {"on", "-76113:-67766,37613:40645,-16702:13708"},
                {"on", "-53053:-28552,57577:78562,14326:42575"},
                {"on", "-58889:-42881,16768:21306,42955:76041"},
                {"on", "-73073:-51398,46632:48316,20149:34615"},
                {"on", "-66303:-54970,-61600:-49802,-11768:9094"},
                {"on", "-53654:-27948,9591:45638,-71810:-58350"},
                {"on", "-69622:-52612,-45011:-38959,24484:44518"},
                {"on", "3515:15378,41121:59682,-61133:-55743"},
                {"on", "-90134:-62577,208:23739,26851:46343"},
                {"on", "65530:81406,42070:52596,-11235:13125"},
                {"on", "64169:84257,-10178:17467,-29044:-16366"},
                {"on", "17446:26654,-66194:-47798,-42530:-24698"},
                {"on", "-58456:-32175,-57823:-50339,35867:54337"},
                {"on", "47156:63257,-36128:-21908,33134:41699"},
                {"on", "-48529:-31263,-62437:-39211,-56496:-37240"},
                {"on", "-34149:-14003,-79123:-45929,-55215:-40418"},
                {"on", "-84191:-64387,-11156:17366,31098:34346"},
                {"on", "-82865:-68797,-5798:8421,28104:58202"},
                {"on", "29311:45767,-88790:-62482,-29612:-214"},
                {"on", "8842:27908,68184:82736,-55247:-19216"},
                {"on", "-42756:-14515,74498:84491,-20007:4343"},
                {"on", "-37638:-28150,-72221:-45636,49412:60164"},
                {"on", "32841:44894,-62963:-55317,-44129:-18308"},
                {"on", "41325:48341,14656:22614,-63334:-57171"},
                {"on", "39491:70558,48229:67699,14708:39318"},
                {"on", "-16935:-15423,72793:82573,-9454:8508"},
                {"on", "28720:40689,29779:36750,-74342:-54201"},
                {"on", "65984:88372,-3884:15208,19130:38834"},
                {"on", "-85972:-61107,-27882:-5274,-23592:-4731"},
                {"on", "-65737:-48051,-4370:32823,-51562:-27039"},
                {"on", "53568:75174,13164:34585,-62900:-49637"},
                {"on", "43348:67279,37890:47849,6060:34285"},
                {"on", "-88633:-60579,-40956:-20401,-20101:8972"},
                {"on", "-70097:-44904,37603:69889,-21021:-5234"},
                {"on", "-76016:-71353,10592:39343,5961:25639"},
                {"on", "26814:51079,-76683:-51852,-32221:-7926"},
                {"on", "78022:90710,-6329:7380,-30398:3225"},
                {"on", "-81947:-59036,6212:27865,-30191:-23650"},
                {"on", "-14260:5518,-59292:-33347,-80781:-44527"},
                {"on", "61127:77249,-44821:-16717,-15659:9963"},
                {"on", "7812:29885,46232:56927,56252:66587"},
                {"on", "-70864:-55068,36351:66673,2115:29365"},
                {"on", "-21385:-5787,-24942:-1426,62656:77888"},
                {"on", "21748:31508,44194:75368,42392:61013"},
                {"on", "-30140:-13716,60038:82957,-55563:-22103"},
                {"on", "15892:46641,28104:45417,-69780:-49812"},
                {"on", "-35304:-14704,-69612:-54212,-64119:-43604"},
                {"on", "-75511:-53167,-16408:-5573,-34276:-13669"},
                {"on", "-49880:-26128,-78019:-53301,563:27150"},
                {"on", "-3710:31007,635:31231,-89739:-67701"},
                {"on", "16417:27647,59484:83416,-38071:-8125"},
                {"on", "-55486:-36218,-18343:-1162,48973:70778"},
                {"on", "6364:25168,-73763:-55266,-47439:-20212"},
                {"on", "-77074:-63388,13325:37503,26475:47125"},
                {"on", "47836:63427,-22005:-1081,-56895:-36496"},
                {"on", "52594:78952,1602:34837,-55674:-29580"},
                {"on", "9195:36803,-42634:-16959,49912:77645"},
                {"on", "-43313:-9809,-61189:-27305,-73518:-57945"},
                {"on", "-15098:-247,-84505:-61173,-6903:10359"},
                {"on", "-14761:20062,42726:66812,-67450:-36194"},
                {"on", "-6269:13514,27764:51152,-65770:-56309"},
                {"on", "-11702:12085,4154:19444,74342:85810"},
                {"on", "20250:40759,-12245:12965,-85663:-56952"},
                {"on", "14397:31766,-77031:-60677,-13856:14510"},
                {"on", "-57268:-50706,-61409:-55384,-8347:2644"},
                {"on", "27634:48898,66690:87119,-27363:-7996"},
                {"on", "11697:40665,-92019:-67357,-28564:-4579"},
                {"on", "-23635:-7962,23732:32687,-83083:-62791"},
                {"on", "40495:46668,-62018:-49602,-65022:-33630"},
                {"on", "13198:30010,-82290:-65531,-17978:9547"},
                {"on", "12582:25248,-22745:3631,70846:86218"},
                {"on", "-26583:-5966,41977:55683,36463:75892"},
                {"on", "-65277:-49356,37876:57024,-52763:-45440"},
                {"on", "-64608:-41498,-8129:16874,50097:71345"},
                {"on", "42175:49606,-70140:-50383,35730:40798"},
                {"on", "54705:58189,-56152:-49341,-400:24932"},
                {"on", "68337:79185,-25307:-6874,-3313:19891"},
                {"on", "5018:29619,62462:81105,18248:30135"},
                {"on", "-76041:-38663,38551:70709,-12671:23088"},
                {"on", "-72729:-54213,-6076:24031,-57821:-37810"},
                {"on", "43326:72010,20000:41816,51160:69275"},
                {"on", "1558:30222,-73358:-70358,16312:51532"},
                {"on", "-35043:-18417,-44261:-25881,-78549:-52077"},
                {"on", "28098:46713,18474:22660,-78742:-54633"},
                {"on", "-14412:8266,70802:80415,-14992:9258"},
                {"on", "-26641:-7645,60425:75589,-43589:-23911"},
                {"on", "-25876:-19902,53219:77507,-48144:-17584"},
                {"on", "-43367:-22330,68271:77937,9057:20584"},
                {"on", "-17237:2381,3583:28698,-94572:-73051"},
                {"on", "-6829:3379,65792:90689,-5002:16981"},
                {"on", "-54132:-45538,-78237:-50736,-11644:8605"},
                {"on", "-59532:-53419,34745:56394,30582:53444"},
                {"on", "-20732:5101,-77256:-61756,30478:35782"},
                {"on", "14347:38867,9283:24381,-87398:-53279"},
                {"on", "36595:57756,38640:51025,-58273:-44565"},
                {"on", "-54582:-27927,-78804:-46081,13910:33182"},
                {"on", "16349:35830,71332:87852,8157:16797"},
                {"on", "-43956:-33473,33808:56755,42846:61246"},
                {"on", "11314:13439,-38033:-17400,-76284:-68981"},
                {"on", "46492:76990,8474:15734,-55742:-41584"},
                {"on", "27131:36354,-29792:-5590,-74708:-55530"},
                {"on", "52353:74451,33392:55689,19093:30505"},
                {"on", "10590:26407,26646:44875,53669:85124"},
                {"on", "10328:23456,52345:77588,31705:56684"},
                {"on", "-46182:-26197,20916:52128,-61613:-51850"},
                {"on", "-5902:15644,7302:32746,-89842:-71630"},
                {"on", "-13813:21172,-87032:-70414,-36:11650"},
                {"on", "-43300:-20544,-39391:-20796,-78685:-54411"},
                {"on", "53826:59621,-22659:6182,34874:57854"},
                {"on", "56180:78116,-17473:-11209,33329:48534"},
                {"on", "-27987:-9324,45080:55335,48847:80731"},
                {"on", "71719:89566,-25531:-10083,-22109:-12785"},
                {"on", "-29430:-21311,-89432:-55080,14731:25873"},
                {"on", "32126:44985,48444:71257,16998:38903"},
                {"on", "24388:50981,-66328:-57172,-52521:-27884"},
                {"on", "30463:45384,-7855:28748,-86869:-55644"},
                {"on", "-67671:-45297,-29469:-5222,44296:53119"},
                {"on", "35058:42106,-69099:-47111,40655:63310"},
                {"on", "33046:64904,-70169:-43042,13896:36888"},
                {"on", "-22322:-13112,-25157:-2838,-93853:-69670"},
                {"on", "73781:84202,-1016:31182,9547:30589"},
                {"on", "-72865:-63710,-50800:-28031,-15998:20829"},
                {"on", "6767:15631,-17255:-11461,-97425:-59135"},
                {"on", "25319:31792,-93050:-64825,8041:20183"},
                {"on", "-70089:-30927,36115:69616,-39401:-14311"},
                {"on", "62942:69074,-22392:-1078,-66440:-27451"},
                {"on", "-13913:4148,-75097:-42466,35698:57507"},
                {"on", "-85917:-59242,-11125:2601,19575:55603"},
                {"on", "15134:42927,-79064:-64982,-1971:24343"},
                {"on", "39880:58909,56469:72390,-1437:26115"},
                {"on", "-21090:-12306,-94355:-77198,-29560:52"},
                {"on", "-28671:-8856,45669:64627,31384:51891"},
                {"on", "-75912:-56733,-23901:1139,28555:57092"},
                {"on", "-47744:-10650,71138:83710,4554:27540"},
                {"on", "25710:42555,-33622:-14274,52056:65528"},
                {"on", "-76115:-63779,-29627:-15804,-1106:16981"},
                {"on", "14189:34263,-62546:-38815,42727:81264"},
                {"on", "7852:41042,31315:42334,55681:71183"},
                {"on", "-88315:-67768,-8097:8232,22878:36892"},
                {"on", "-75367:-48994,-65971:-49798,-331:14292"},
                {"on", "-25718:1445,-80169:-61373,-57242:-32282"},
                {"on", "-13075:7644,-14640:-3379,75167:96592"},
                {"on", "35741:67984,-60591:-37834,-42879:-23133"},
                {"on", "-26071:-15399,-54535:-33151,64373:77023"},
                {"on", "70725:90684,8312:29942,-28004:2695"},
                {"on", "54936:67698,10377:30841,-45783:-36371"},
                {"on", "-2020:25407,-78434:-50839,-48610:-39223"},
                {"on", "-45717:-43647,48801:70774,31062:45511"},
                {"on", "34206:54314,-70584:-47392,-45786:-24983"},
                {"on", "-49858:-27145,-8313:12257,-80733:-65761"},
                {"on", "19194:48953,-76824:-50937,-38483:-20184"},
                {"on", "-11056:8975,60011:77711,-47016:-22798"},
                {"on", "23444:61412,-8792:27162,54757:77897"},
                {"on", "-75528:-48686,-2534:13417,-72418:-47078"},
                {"on", "21664:55288,9053:15264,54771:84777"},
                {"on", "45230:57868,-35816:-19600,-70489:-40910"},
                {"on", "30646:56513,-73290:-51396,-48109:-23594"},
                {"on", "-19927:8133,20111:22064,-78790:-65966"},
                {"on", "-73214:-50284,-42781:-29543,-52080:-40858"},
                {"on", "59641:92804,-14320:9890,10580:32686"},
                {"on", "6948:24112,59008:83939,9209:29435"},
                {"on", "20747:42638,54010:87392,-10349:6792"},
                {"on", "-82467:-56030,-63078:-36419,-18052:-7281"},
                {"on", "43143:53517,-42852:-33677,-75322:-38352"},
                {"on", "34903:68087,-53600:-43300,19263:37332"},
                {"on", "-75090:-51229,39553:54421,-29984:-11983"},
                {"on", "31297:41923,40810:55544,41336:65242"},
                {"on", "48907:76926,44120:55019,19408:32113"},
                {"on", "-28350:-11619,-96073:-68302,7131:23826"},
                {"on", "-71444:-52453,-46437:-37331,-23610:-7727"},
                {"on", "-90114:-62112,-11142:11966,10310:30329"},
                {"on", "-8298:10663,-89901:-65346,26819:55136"},
                {"on", "-83214:-52210,-28546:-6449,26105:44117"},
                {"on", "-48292:-15887,-32421:-24179,-72733:-50252"},
                {"on", "2675:6592,57643:77972,-45680:-31319"},
                {"on", "-27301:-19021,52139:65771,40324:62506"},
                {"on", "-15122:12261,76124:83252,-6966:26871"},
                {"on", "-28135:-5592,42253:66391,61120:81631"},
                {"on", "41458:59123,-65686:-28325,18007:42560"},
                {"on", "-7254:2575,-37975:-25118,-83436:-55842"},
                {"on", "-69756:-51850,-14700:11743,-64913:-57730"},
                {"on", "46050:60943,29947:49852,-29174:-16871"},
                {"on", "-24798:-1730,72778:96749,7809:19201"},
                {"on", "-23651:-9598,-57234:-34582,-70338:-60811"},
                {"off", "-62738:-27200,9928:29860,-82061:-55735"},
                {"off", "-35621:-8459,71584:77639,-24783:543"},
                {"on", "5884:24918,4508:27365,-79957:-56399"},
                {"off", "50195:64289,48376:65137,-21184:896"},
                {"off", "24188:59760,-44337:-27583,42362:66284"},
                {"off", "-57347:-28736,-60601:-44136,-63070:-43716"},
                {"off", "48377:66842,5381:28487,-56713:-36405"},
                {"off", "-30632:-10325,-68112:-57776,-70249:-44986"},
                {"on", "-27258:-24687,-27831:179,67481:80119"},
                {"off", "25197:36490,58147:79063,-55819:-29388"},
                {"on", "-42369:-14014,35824:40212,49626:67639"},
                {"on", "72482:78811,2743:24960,-21034:9641"},
                {"on", "-38737:-16444,-19459:-7136,70522:89734"},
                {"off", "-47053:-18446,-49781:-27644,-63382:-45445"},
                {"on", "-61779:-53562,-68401:-43173,-26499:2615"},
                {"on", "70280:90492,-22017:-1048,-11788:9915"},
                {"on", "16973:40998,55375:78623,5729:32627"},
                {"on", "6679:29613,46958:81428,27700:55392"},
                {"off", "-54278:-31989,37760:65264,47082:48144"},
                {"on", "-24395:-1817,-3077:6849,62195:88101"},
                {"off", "32931:47933,-80935:-47905,12414:35416"},
                {"on", "-4833:29094,-74517:-46510,-50662:-36261"},
                {"off", "17745:39300,-77063:-52076,14430:34896"},
                {"on", "-4254:2793,-27799:-2199,61332:85652"},
                {"on", "-11125:-6797,-67626:-59797,45783:53770"},
                {"on", "-51997:-22683,-75871:-59016,-35612:-29371"},
                {"off", "-53070:-30804,-37612:-16817,-61098:-33579"},
                {"on", "-52249:-27676,65019:73794,8944:31489"},
                {"on", "54561:70311,8710:27762,-60193:-29447"},
                {"on", "-79526:-54134,-48561:-39181,12782:46387"},
                {"off", "19885:33599,62071:83093,-50279:-13755"},
                {"on", "23245:46830,20494:44306,-73620:-54933"},
                {"on", "-79449:-67759,-24475:-10791,5687:32934"},
                {"off", "-30071:-21031,54871:72346,32042:55267"},
                {"off", "-30238:-2898,-77564:-51143,35341:64987"},
                {"off", "54103:57884,36694:60345,-45985:-16112"},
                {"on", "52740:71478,15648:46995,9255:41940"},
                {"off", "47709:56624,42824:76404,-16692:-4361"},
                {"off", "-79808:-65764,11636:14621,6874:40024"},
                {"off", "-53031:-20679,-63906:-40440,24661:46608"},
                {"off", "21238:38683,-78416:-46878,-47880:-35504"},
                {"on", "-53581:-36276,-1941:20566,-71887:-54358"},
                {"off", "-32154:-11432,-79738:-67958,-10706:17360"},
                {"off", "10696:21438,-53803:-22129,-87224:-56070"},
                {"off", "28285:52461,-49037:-26856,36499:53886"},
                {"on", "-260:5955,24586:37153,-83960:-67924"},
                {"off", "-50570:-23890,-75797:-57497,-41895:-29533"},
                {"off", "-4478:14154,25690:41167,-78169:-65042"},
                {"off", "53823:62681,-65274:-48164,11640:36739"},
                {"off", "7445:17160,3112:20438,-79277:-66317"},
                {"off", "-72283:-62851,-18551:17812,26518:45970"},
                {"off", "-59435:-35677,-61145:-49053,-28620:-19260"},
                {"on", "52909:71776,-35904:-8679,-45640:-18257"},
                {"on", "-28198:-10547,47520:75387,-56238:-36602"},
                {"on", "-78021:-57108,-202:20511,22910:26211"},
                {"on", "6366:17660,-81206:-59720,-20739:4299"},
                {"off", "62320:70434,-46472:-33338,24434:41197"},
                {"on", "65053:71471,16283:27975,-53360:-32879"},
                {"on", "25858:60433,-26017:-21914,48513:63801"},
                {"off", "-79152:-68671,22088:30479,-22648:-10494"},
                {"off", "67085:79404,-9147:17587,-34597:-22908"},
                {"on", "-25433:-14453,-65170:-45979,46473:59725"},
                {"on", "-85030:-67943,-43295:-20298,-28190:-8337"},
                {"off", "14793:29071,51299:70682,-63333:-48581"},
                {"on", "-22738:-3843,62665:91255,-40441:-6764"},
                {"off", "-69466:-51782,-28726:-4741,51052:65722"},
                {"off", "-37894:-19524,-83016:-54967,-15269:4234"},
                {"off", "-51737:-36058,49755:52567,40935:52695"},
                {"on", "5160:16270,-63557:-29172,-66325:-60455"},
                {"on", "-12754:14999,42410:57660,-81237:-44235"},
                {"off", "-21896:-1639,-6683:12111,-86947:-66486"},
                {"on", "17671:34865,25801:50054,-69110:-52941"},
                {"off", "53780:79949,-19080:-1582,-51267:-26442"},
                {"on", "11705:31955,-18273:10873,-79513:-72321"},
                {"off", "42225:64739,-63751:-38399,-21976:3241"},
                {"on", "-83556:-68733,-27434:-7743,-13017:9177"},
                {"on", "56237:76149,-34497:-16008,-39077:-19458"},
                {"on", "-43305:-25014,-73343:-49996,-7825:-3892"},
                {"on", "-64308:-43967,-33788:-28512,52866:68806"},
                {"on", "-70700:-50756,31972:50876,-38908:-15838"},
                {"off", "-57164:-42932,19342:48612,33732:55624"},
                {"on", "-36748:-10589,51955:83318,-48442:-26669"},
                {"on", "25359:40927,-79085:-59846,8036:36888"},
                {"off", "10380:14539,71572:87896,-24628:-4781"},
                {"off", "-47176:-28461,65456:67163,-40894:-16836"},
                {"off", "-18332:8399,47821:71986,26668:47522"},
                {"on", "-20965:-9481,-20308:4897,-95419:-57801"},
                {"off", "31539:51751,35462:53163,-57494:-42838"},
                {"off", "-18472:1572,75988:93471,-26864:1039"},
                {"on", "-70785:-33731,-73997:-43660,-23224:9946"},
                {"on", "19380:37078,53776:78064,-31936:-10509"},
                {"on", "-8062:-2825,-82342:-69826,-13266:3969"},
                {"off", "10179:29342,31007:48598,64959:69127"},
                {"off", "-60805:-32266,43431:69404,8577:28595"},
                {"off", "-22720:-3203,60404:66611,34857:59638"},
                {"off", "-53582:-38618,52017:73240,27473:42769"},
                {"off", "-72814:-66689,-45388:-21812,-14516:3856"},
                {"on", "-73641:-69708,-15500:7339,-39764:-29382"},
                {"off", "-4677:17044,-91970:-68336,-5685:15742"},
                {"on", "11739:24073,35242:45244,-80024:-60736"},
                {"on", "64670:76998,26199:39053,-15372:11264"},
                {"on", "32930:62408,7820:14870,-84786:-50274"},
                {"off", "1793:28795,19984:43135,67050:87662"},
                {"on", "62730:81556,-59681:-32462,-9119:17314"},
                {"off", "51211:84860,-10649:27833,33629:61327"},
                {"on", "4877:24218,58754:64225,-51294:-29252"},
                {"on", "-34998:-23262,-7791:15688,-77251:-73653"},
                {"on", "-8985:2565,-80674:-57237,31372:66054"},
                {"on", "26910:46858,-70174:-50719,-39433:-6303"},
                {"on", "-77313:-45494,-35534:-19783,-56939:-23493"},
                {"off", "-86093:-58555,-10764:-7163,32984:39939"},
                {"off", "22629:45516,56413:69690,23879:45264"},
                {"off", "6426:22257,-81295:-58682,-4833:30396"},
                {"on", "-20499:-623,68725:85089,-3165:16088"},
                {"on", "-22113:-8769,50723:69731,35423:63761"},
                {"off", "17927:28889,66820:87168,7146:17344"},
                {"on", "-51150:-32434,4434:29601,-87179:-50635"},
                {"on", "44312:65806,-17376:-4824,-60807:-46664"},
                {"off", "-74021:-63274,18155:23737,23087:44175"},
                {"on", "53142:78645,11091:24149,-33898:-15733"},
                {"on", "-89734:-59095,5415:39645,-30819:-14415"},
                {"off", "-3526:9687,44579:60215,-61672:-41733"},
                {"off", "73321:97678,7224:33092,-23526:-6480"},
                {"on", "-38319:-18652,-94091:-57143,-27008:-10399"},
                {"off", "-39624:-25656,-27151:-17149,62826:73496"},
                {"off", "11777:31489,27498:41343,-66823:-64400"},
                {"off", "-86379:-57406,1305:22612,-19292:-12364"},
                {"off", "46778:72347,-30615:-14497,-57631:-38999"},
                {"off", "11620:35158,60858:89766,3059:17854"},
                {"off", "12508:29190,-69508:-58455,23048:41891"},
                {"on", "-18252:13098,36042:44460,50978:82816"},
                {"on", "-6496:13599,-32852:-21957,70926:82031"},
                {"on", "69343:93866,-13495:12902,20150:37520"},
                {"on", "14399:46141,-16440:-4786,64520:82073"},
                {"on", "34907:49197,-77417:-58364,7116:41283"},
                {"off", "-964:13645,-84374:-61091,5528:26680"},
                {"on", "17413:51768,18101:39773,59112:72097"},
                {"on", "-66173:-34985,-64364:-26681,-46312:-32514"},
                {"on", "4907:25817,-86293:-63574,20626:51969"},
                {"off", "25870:59523,34211:49946,40232:74133"},
                {"off", "-54230:-38453,30481:43869,-54591:-40302"},
                {"on", "-19584:11278,-61815:-44911,-59169:-54278"},
                {"off", "9524:37706,69604:90591,2047:19112"},
                {"off", "-55707:-36536,32805:48941,-69826:-44814"},
                {"off", "-47397:-26251,-45541:-17561,51498:63966"},
                {"on", "-26274:-8974,-11082:14341,-95770:-63704"},
                {"on", "63227:82757,-53349:-33869,6276:38367"},
                {"off", "-9009:17116,-1685:15956,-89391:-75291"},
                {"off", "-60467:-32934,-16532:8638,66520:73970"},
                {"on", "42282:63814,-52404:-29292,16300:39083"},
                {"on", "59807:76726,-59577:-30112,-6617:22740"},
                {"off", "-71581:-61332,-11793:7729,28377:51215"},
                {"off", "58949:86888,-38405:-857,-27434:-1959"},
                {"on", "-38039:-18664,-52842:-30904,-69197:-39328"},
                {"on", "34271:60705,-13427:9155,-86631:-62294"},
                {"on", "-47181:-37507,52951:66180,31932:41322"},
                {"on", "50153:80932,-4041:16916,32832:52829"},
                {"on", "-5561:25588,-10476:10520,78611:97383"},
                {"off", "-83214:-60530,-3562:17310,7405:28737"},
                {"on", "-60777:-54134,54086:73346,-11397:12806"},
                {"on", "8008:14420,-63596:-41593,-68526:-45673"},
                {"off", "24007:49083,-16462:-7045,57536:81481"},
                {"off", "-11681:3645,-58012:-41953,55142:76200"},
                {"off", "-76656:-52954,35846:55582,-53872:-34722"},
                {"on", "-12038:8659,-87346:-69918,28070:47940"},
                {"on", "-11947:10184,-53409:-34027,-72583:-47438"},
                {"off", "-55067:-35621,-69939:-60505,-14835:1042"},
                {"off", "32935:37139,-85226:-70552,-25685:4412"},
                {"on", "-28948:-4652,36671:63289,-68708:-50580"},
                {"off", "11959:12834,37735:57272,-76650:-51945"},
                {"off", "-80869:-62027,-29135:1722,-41049:-20272"},
                {"off", "-16105:-9908,13813:43802,-91236:-73026"},
                {"on", "-49560:-40469,43630:61941,-52839:-35457"},
                {"off", "9147:25541,-80287:-59670,42741:55735"},
                {"off", "50379:79472,29160:49483,-5978:29107"},
                {"on", "-88412:-58603,-3423:3159,19531:41416"},
                {"off", "-1015:23656,53461:84876,27264:47816"},
                {"off", "-34955:-31932,56566:75983,-11994:10763"},
                {"off", "-33477:-1860,19104:24306,-77651:-71897"},
                {"on", "-73047:-48583,28931:56704,23154:30012"},
                {"off", "70083:72794,-5597:15786,-51791:-23271"},
                {"on", "28989:57370,40583:60178,-62971:-45863"},
                {"on", "55125:91706,-15559:4561,15786:49181"},
                {"off", "-24690:-3730,59694:97039,724:22523"},
                {"on", "50442:59532,-34136:-13939,-73167:-41283"},
                {"on", "-42457:-22829,28486:55735,-61093:-54803"},
                {"off", "59374:88933,-35520:-16575,21065:24982"},
                {"off", "47891:77004,-55581:-33892,-24958:-20207"},
                {"on", "-39381:-6103,25106:44027,51236:84981"},
                {"off", "53027:72033,-66349:-40215,-1886:6465"},
                {"off", "-16688:3581,-13126:2347,-92211:-65235"},
                {"on", "-42613:-26870,-29924:-12291,-67035:-61494"},
                {"off", "63092:79122,988:21133,-16953:3867"},
                {"off", "-67216:-58011,-53495:-33034,-11608:-1856"},
                {"off", "53934:86965,-44444:-9436,16273:30447"},
                {"off", "-4034:19635,-54143:-37719,-78365:-41039"},
                {"on", "-34211:-14894,-25413:-719,56386:88338"},
                {"on", "-57326:-35994,-38049:-8173,-56649:-54035"},
                {"off", "30271:50936,-87052:-56522,3300:32145"},
                {"on", "55833:75804,18495:43321,-27127:-11497"}
        };
        //</editor-fold>

        long start = System.currentTimeMillis();
        VolumeSet vs = new VolumeSet();
        for (String[] instruction : instructions) {
            String[] split = instruction[1].split("[:,]");
            int[] mins = new int[split.length/2];
            int[] maxs = new int[split.length/2];
            for (int i = 0; i < mins.length; i++) {
                mins[i] = parseInt(split[i*2]);
                maxs[i] = parseInt(split[i*2+1]);
            }
            Cuboid c = new Cuboid(new Coordinate(mins), new Coordinate(maxs));

            if (instruction[0].equals("on")) {
                vs.add(c);
            } else if (instruction[0].equals("off")) {
                vs.subtract(c);
            } else {
                throw new RuntimeException("unknown instruction");
            }
        }

        assertThat(System.currentTimeMillis() - start).isLessThan(5000);
    }

    private static long countLayeredPoints(VolumeSet volumeSet) {
        int minX = volumeSet.cuboids.stream().mapToInt(c -> c.min(0)).min().orElse(0);
        int maxX = volumeSet.cuboids.stream().mapToInt(c -> c.max(0)).max().orElse(0);
        int minY = volumeSet.cuboids.stream().mapToInt(c -> c.min(1)).min().orElse(0);
        int maxY = volumeSet.cuboids.stream().mapToInt(c -> c.max(1)).max().orElse(0);

        long totalCount = 0;
        for (int j = minY; j <= maxY; j++) {
            for (int i = minX; i <= maxX; i++) {
                int I = i, J = j;
                long count = volumeSet.cuboids.stream().filter(r -> r.contains(new Coordinate(I,J))).count();
                if (count > 1) {
                    totalCount++;
                }
            }
        }
        return totalCount;
    }

}